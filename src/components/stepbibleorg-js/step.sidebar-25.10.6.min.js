var SidebarModel = Backbone.Model.extend({
  defaults: {
    mode: 0,
    strong: "H0001",
    morph: undefined,
  },
});
var SidebarList = Backbone.Collection.extend({
  model: SidebarModel,
  localStorage: new Backbone.LocalStorage("sidebar"),
  initialize: function () {},
});
var ViewLexiconWordle = Backbone.View.extend({
  events: {},
  minFont: 14,
  minSubjectFont: 12,
  maxFont: 24,
  passageId: 0,
  initialize: function () {
    var b = this;
    this.isNextChapter = false;
    var c = $("<form class='scopeContainer '>");
    this.wordType = this.σwB(
      step.defaults.analysis.kind,
      step.defaults.analysis.kindTypes,
      __s.analyse_label,
      "wordType"
    );
    this.wordScope = this.σwB(
      step.defaults.analysis.scope,
      step.defaults.analysis.scopeType,
      __s.bible_text,
      "wordScope",
      true
    );
    this.sortSelection = this.σwB(
      step.defaults.analysis.sort,
      step.defaults.analysis.sortType,
      __s.analyse_sort_label,
      "sortSelection"
    );
    this.newLineSelected = $(
      '<button class="btn btn-default btn-xs pull-right" id="newLineWordle"><span type="button"/>Selected passage</button>'
    );
    this.resultWithLineBreak = $(
      '<input type="checkbox" id="resultWithLineBreak" checked="checked" class="pull-right" />'
    );
    this.nextChapter = $(
      '<button class="btn btn-default btn-xs pull-right" id="nextChapterWordle"><span type="button"/>' +
        __s.stats_next_chapter +
        "</button>"
    );
    this.statsContainer = $('<div id="statsContainer"></div>');
    this.σwA(this.resultWithLineBreak);
    c.append(this.wordType);
    c.append(this.wordScope);
    c.append(this.scope);
    c.append(this.sortSelection);
    c.append(
      $(
        '<div class="form-group"><label for="resultWithLineBreak">' +
          __s.analyse_result_linebreak +
          "</label></div>"
      ).append(this.resultWithLineBreak)
    );
    c.append(
      $(
        '<div id="nextChapterInputLine" class="form-group"><label for="nextChapterWordle">' +
          __s.analyse_update +
          ":</label></div>"
      )
        .append(this.nextChapter)
        .append(this.newLineSelected)
    );
    var a = c;
    a.append(this.statsContainer);
    if (step.touchDevice && !step.touchWideDevice) {
      step.util.σuu("", __s.vocabulary_analysis, [a]);
    } else {
      this.$el.append("<h2>" + __s.vocabulary_analysis + "</h2>");
      this.$el.append(a);
    }
    this.newLineSelected.click(function (d) {
      event.preventDefault();
      b.σwE();
    });
    this.nextChapter.click(function (d) {
      b.isNextChapter = true;
      event.preventDefault();
      b.σwE();
    });
  },
  refresh: function () {
    if (
      this.$el.hasClass("active") ||
      (step.touchDevice && !step.touchWideDevice)
    ) {
      this.σwE();
    }
  },
  σwA: function (b) {
    var a = this;
    b.click(function () {
      a.σwE();
    });
  },
  σwB: function (e, o, j, b, n) {
    var p = this;
    var a = $('<div class="form-group">');
    var j = $("<label></label>").append(j).attr("for", b);
    var g = $('<div class="btn-group pull-right"></div>').attr("id", b);
    var l = $('<span class="currentRef"></span>');
    var f = $(
      '<button type="button" data-toggle="dropdown" class="btn btn-default btn-xs dropdown-toggle"></div>'
    )
      .append(l)
      .append('<span class="caret"></span>');
    var c = $('<ul class="dropdown-menu" role="menu"></ul>');
    for (var d = 0; d < e.length; d++) {
      var h = $(
        '<a role="menuitem" tabIndex="-1" href="javascript:void(0)">' +
          e[d] +
          "</a>"
      );
      var m = $('<li role="presentation"></li>');
      m.append(h.prepend(step.util.ui.σiA()));
      if (!n && d == 0) {
        m.addClass("selected").find(".glyphicon").addClass("active");
      }
      m.data("value", o[d]);
      c.append(m);
    }
    var k = c.find("li:first");
    if (k.text() === "") {
      l.html(k.find("input").val());
    } else {
      l.html(k.text());
    }
    c.find("a").click(function () {
      var r = $(this);
      var q = r.text();
      if (q === "") {
        var i = r.find("input").val();
        l.html(i);
        r.closest("li").data("value", i);
      } else {
        l.html(q);
      }
      r.closest("ul")
        .find("li")
        .removeClass("selected")
        .find(".active")
        .removeClass("active");
      r.parent().addClass("selected").find(".glyphicon").addClass("active");
      p.σwE();
    });
    c.find("input")
      .click(function (i) {
        i.stopPropagation();
        i.preventDefault();
      })
      .on("keydown", function (r) {
        r.stopPropagation();
        var q = r.keyCode ? r.keyCode : r.which;
        if (q == 13) {
          r.preventDefault();
          var i = $(this);
          l.html(i.val());
          i.closest("ul").removeClass("selected");
          i.closest("li").addClass("selected").data("value", i.val());
          p.σwE();
        }
      });
    a.append(j);
    g.append(f);
    g.append(c);
    a.append(g);
    return a;
  },
  σwC: function (a) {
    return step.util
      .σuc(a.get("passageId"))
      .find(".verseNumber")
      .closest("a[name]")
      .attr("name");
  },
  σwD: function (j, k, e, i) {
    var l = this;
    var f = step.util.σuQ();
    var h = f.get("reference") || this.σwC(f);
    var b = f.get("masterVersion");
    var d = this.isNextChapter ? this.transientReference || h : h;
    var c = step.defaults.analysis.scopeType;
    if (c.indexOf(k) == -1) {
      k = c[0];
    }
    var a = e === "SORT_BY_REVERSED_FREQUENCY" ? false : true;
    this.statsContainer.empty();
    var g = step.userLanguageCode ? step.userLanguageCode.toLowerCase() : "en";
    $.getSafe(
      ANALYSIS_STATS,
      [b, d, j, k, this.isNextChapter, g, a],
      function (m) {
        l.transientReference = m.passageStat.reference.name;
        l.σwG(
          l.statsContainer,
          k,
          m.passageStat,
          j,
          i,
          m.lexiconWords,
          l.isNextChapter,
          l.transientReference
        );
      }
    ).error(function () {
      changeBaseURL();
    });
    this.isNextChapter = false;
  },
  σwE: function () {
    this.σwD(
      this.wordType.find(".selected").data("value"),
      this.wordScope.find(".selected").data("value"),
      this.sortSelection.find(".selected").data("value"),
      function (b, c) {
        if (c == "WORD") {
          var a = "strong=" + encodeURIComponent(b);
          step.router.σmC(a, false, true);
        } else {
          if (c == "TEXT") {
            var a = "text=" + encodeURIComponent(b);
            step.router.σmC(a, false, true);
          } else {
            if (c == "SUBJECT") {
              var a = "subject=" + encodeURIComponent(b);
              step.router.σmC(a, false, true);
            }
          }
        }
      }
    );
  },
  σwF: function (j, i, n, m, g, k) {
    var a = step.defaults.analysis;
    var l = a.scope[a.scopeType.indexOf(n)];
    var h = this.resultWithLineBreak.prop("checked");
    var f = h ? 10 : i[0];
    var c = $("<a></a>").attr("href", "javascript:void(0)").attr("rel", f);
    if (h) {
      if (m === "WORD") {
        c.attr(
          "title",
          sprintf(__s.stats_occurs_times_in_book_bible, i[1], i[2])
        );
      }
    } else {
      c.attr("title", sprintf(__s.stats_occurs_times, i[0], l));
    }
    if (g && g[j]) {
      var e = step.util.ui.σic(j);
      if (g[j].matchingForm) {
        var d = $("<span>" + g[j].matchingForm + "</span>").addClass(e);
        c.append(d);
        c.append(" (");
        if (h) {
          var b = $("<i>" + g[j].stepTransliteration + "</i>");
          c.append(b);
          c.append(") ");
          c.append(g[j].gloss);
          c.append(" - ");
          c.append(i[0]);
          c.append(__s.analyse_times);
        } else {
          c.append(g[j].gloss);
          c.append(")");
        }
        c.prop("strong", j);
      } else {
        c.append(g[j].gloss);
        c.append(" - ");
        c.append(i[0]);
        c.append(" ");
        c.append(__s.analyse_times);
      }
    } else {
      c.html(j);
      c.append(" - ");
      c.append(i[0]);
      c.append(" ");
      c.append(__s.analyse_times);
    }
    c.attr("key", j);
    c.click(function () {
      step.util.σuQ().save({
        strongHighlights: "",
      });
      k(j, m);
    });
    return c;
  },
  σwG: function (a, m, k, l, i, d, b, f) {
    var j = this;
    var c = [];
    var e = f;
    if (m === "BOOK") {
      e = e.replace(/\d+$/, "");
    }
    var h =
      step.defaults.analysis.scope[step.defaults.analysis.scopeType.indexOf(m)];
    $(a).append(
      '<span style="font-size:150%;font-weight:bold">' +
        e +
        " (" +
        h +
        "):</span><br><br>"
    );
    $.each(k.stats, function (n, o) {
      c.push(n);
    });
    if (
      this.sortSelection.find(".selected").data("value") ===
      step.defaults.analysis.sortType[0]
    ) {
      c.sort(function (o, n) {
        var p = k.stats[n][0] - k.stats[o][0];
        if (p == 0) {
          p = k.stats[n][1] - k.stats[o][1];
          if (p == 0) {
            p = k.stats[n][2] - k.stats[o][2];
            if (p == 0) {
              p = o.toLowerCase() < n.toLowerCase() ? -1 : 1;
            }
          }
        }
        return p;
      });
    } else {
      if (
        this.sortSelection.find(".selected").data("value") ===
        step.defaults.analysis.sortType[1]
      ) {
        c.sort(function (n, o) {
          var p = k.stats[n][0] - k.stats[o][0];
          if (p == 0) {
            p = k.stats[n][1] - k.stats[o][1];
            if (p == 0) {
              p = k.stats[n][2] - k.stats[o][2];
              if (p == 0) {
                p = n.toLowerCase() < o.toLowerCase() ? -1 : 1;
              }
            }
          }
          return p;
        });
      } else {
        c.sort(function (o, n) {
          return o.toLowerCase() < n.toLowerCase() ? -1 : 1;
        });
      }
    }
    $("a", a).attr("rel", 0);
    $.each(c, function (o, p) {
      var q = k.stats[p];
      var n;
      if (n == null) {
        n = j.σwF(p, q, m, l, d, i);
        a.append(n);
        if (j.resultWithLineBreak.prop("checked")) {
          a.append("<br>");
        } else {
          a.append(" ");
        }
      }
    });
    var g = $("a", a);
    if (l === "WORD") {
      g.hover(
        function () {
          step.passage.σpB({
            strong: $(this).prop("strong"),
          });
        },
        function () {
          step.passage.σpC(step.passage.σpA(this));
        }
      );
    }
    if (m === "CHAPTER" && !k.reference.lastChapter) {
      $("#nextChapterWordle").show();
      $("#nextChapterInputLine").show();
    } else {
      $("#nextChapterWordle").hide();
      $("#nextChapterInputLine").hide();
    }
    $("#newLineWordle").hide();
  },
});
var ViewHistory = Backbone.View.extend({
  MAX_HISTORY: 250,
  itemTemplate: _.template(
    '<li class="list-group-item historyItem" data-item="<%= item.get("id") %>"><span class="argSummary argSumSpan" style="text-decoration:underline;display:inline"><%= step.util.ui.σiC(item.get("searchTokens"), null, "span") %></span><a class="removeBookmark" title="<%= __s.bookmark_remove %>" style="float:right;padding-left:15px"><span class="glyphicon glyphicon-remove"></span></a><a class="starBookmark" data-favourite="<%= item.get("favourite")%>" title="<%= item.get("favourite") ? __s.passage_tools_delete_bookmark : __s.passage_tools_bookmark %>" style="float:right"><span class="glyphicon <%= (item.get("favourite") && (!step.touchDevice || step.touchWideDevice)) ? "glyphicon-pushpin-pinned" : "glyphicon-pushpin" %>"></span></a></li>'
  ),
  fullList: _.template(
    '<h2><%= __s.bookmarks_pinned %></h2><ul class="list-group"><% var bks = bookmarks.where({favourite: true }); for(var i = 0; i < bks.length; i++) { %><%= view.itemTemplate({ item: bks[i], view: view }) %> <% } %></ul><h2><%= __s.bookmarks_recent %></h2><ul class="list-group"><% var bks = bookmarks.where({favourite: false }); for(var i = 0; i < bks.length; i++) { %><%= view.itemTemplate({ item: bks[i], view: view }) %> <% } %></ul>'
  ),
  initialize: function () {
    var a = this;
    this.listenTo(step.bookmarks, "change:lastAccessed", this.updatedBookmark);
    this.listenTo(step.bookmarks, "add", this.addItem);
    this.listenTo(step.bookmarks, "remove", this.removeItem);
    this.render();
  },
  σhA: function (a) {
    var c = $(a).closest("li");
    var b = c.data("item");
    step.bookmarks
      .findWhere({
        id: b,
      })
      .destroy();
    c.remove();
  },
  σhB: function (a) {
    var d = $(a).closest("li");
    var c = d.data("item");
    var b = step.bookmarks.findWhere({
      id: c,
    });
    b.save({
      favourite: !b.get("favourite"),
    });
    step.bookmarks.sort();
    this.render();
  },
  σhC: function (a) {
    var d = $(a).closest("li");
    var c = d.data("item");
    var b = step.bookmarks.findWhere({
      id: c,
    });
    step.router.doMasterSearch(
      decodeURIComponent(b.get("args")),
      b.get("options") || "",
      b.get("display") || ""
    );
    if (step.touchDevice && !step.touchWideDevice) {
      step.util.closeModal("showLongAlertModal");
    }
  },
  render: function () {
    var a = this;
    if (this.list) {
      this.list.remove();
      this.list = null;
    }
    this.σhF();
    var b =
      step.touchDevice && !step.touchWideDevice ? $(".modal-body") : this.$el;
    b.find(".argSumSpan").click(function () {
      a.σhC(this);
    });
    b.find(".removeBookmark").click(function () {
      a.σhA(this);
    });
    b.find(".starBookmark").click(function () {
      a.σhB(this);
    });
  },
  refresh: function () {
    if (this.$el.hasClass("active")) {
      this.render();
    }
  },
  addItem: function (b) {
    var c = $(
      this.itemTemplate({
        item: b,
        view: this,
      })
    );
    var a = this;
    this.σhD(b, c);
    c.find(".removeBookmark").click(function () {
      a.σhA(this);
    });
    c.find(".starBookmark").click(function () {
      a.σhB(this);
    });
    var e = this.$el.find(".historyItem").not(":has([data-favourite='true'])");
    if (e.length > this.MAX_HISTORY) {
      var f = e.last().data("item");
      var d = step.bookmarks.findWhere({
        id: f,
      });
      if (d) {
        this.removeItem(d);
      }
    }
  },
  removeItem: function (a) {
    this.σhE(a).remove();
    a.destroy();
  },
  updatedBookmark: function (a) {
    this.σhD(a, this.σhE(a));
  },
  σhD: function (a, b) {
    try {
      if (a.get("favourite")) {
        var d = this.σhF().find("li:has([data-favourite='true']):first");
        if (d.length > 0) {
          b.insertBefore(d);
        } else {
          this.σhF().filter(".list-group:first").append(b);
        }
      } else {
        var d = this.σhF().find("li:has([data-favourite='false']):first");
        if (d.length > 0) {
          b.insertBefore(d);
        } else {
          this.σhF().filter(".list-group:last").append(b);
        }
      }
    } catch (c) {
      console.log("FAILED TO ADD BOOKMARK");
    }
  },
  σhE: function (a) {
    return this.$el.find("li[data-item='" + a.get("id") + "']");
  },
  σhF: function () {
    if (this.list) {
      return this.list;
    }
    this.list = $(
      this.fullList({
        bookmarks: step.bookmarks,
        view: this,
      })
    );
    if (step.touchDevice && !step.touchWideDevice) {
      step.util.σuu("", "<b>Bookmarks</b>", [this.list]);
      step.sidebar = null;
    } else {
      this.$el.append(this.list);
    }
    return this.list;
  },
});
var SidebarView = Backbone.View.extend({
  lastMorphCode: "",
  initialize: function () {
    step.util.σuV(true);
    _.bindAll(this);
    this.sidebarButton = $(".navbar-brand .showSidebar");
    this.sidebarButtonIcon = this.sidebarButton.find(".glyphicon");
    this.tabContainer = this._createBaseTabs();
    this.tabHeaders = this._createTabHeadersContainer();
    this.$el.append(this.tabHeaders);
    this.$el.append(this.tabContainer);
    this.$el.on("show.bs.tab", this.changeMode);
    this.listenTo(this.model, "change", this.activate);
    this.listenTo(this.model, "toggleOpen", this.toggleOpen);
    this.listenTo(this.model, "forceOpen", this.openSidebar);
    this.activate();
    this.$el
      .find('a[data-toggle="tab"]')
      .on("shown.bs.tab", this._notifyTabPanes);
  },
  _notifyTabPanes: function (a) {
    a.stopPropagation();
    this.$el.find(".tab-pane").trigger("tab-change", {
      newTab: a.target,
    });
  },
  changeMode: function (c) {
    var d = null;
    var a = $(c.target);
    var b = a.data("target");
    if (b == "#lexicon") {
      d = "lexicon";
    } else {
      if (b == "#analysis") {
        d = "analysis";
      } else {
        if (b == "#history") {
          d = "history";
        } else {
          if (b == "#help") {
            d = "help";
          } else {
            if (b == "#color") {
              d = "color";
            }
          }
        }
      }
    }
    this.model.save({
      mode: d,
    });
  },
  activate: function () {
    var k = this;
    if (!step.touchDevice || step.touchWideDevice) {
      this.openSidebar();
    }
    this.$el
      .find("[data-target='#" + this.model.get("mode") + "']")
      .tab("show");
    if (this.model.get("mode") == "lexicon") {
      this.lexicon.addClass("active");
      lastMorphCode = "";
      var h = this.model.get("strong");
      var i = this.model.get("morph");
      if (
        h.substring(0, 1) === "H" &&
        typeof i === "string" &&
        i.substring(0, 4) !== "TOS:"
      ) {
        i = "TOS:" + i;
      }
      var j = step.util.σMT(i);
      if (j != undefined) {
        lastMorphCode = j;
      }
      var c = this.model.get("morphCount");
      var b = this.model.get("ref");
      var g = this.model.get("version");
      var f = this.model.get("allVersions");
      var d = this.model.get("variant") || "";
      d = d.split(";");
      if (typeof f !== "string") {
        if (typeof g === "string") {
          f = g;
        } else {
          f = step.util.σuQ().get("masterVersion");
          var a = step.util.σuQ().get("extraVersions");
          if (typeof a === "string" && a !== "") {
            f += "," + a;
          }
        }
      }
      if (
        typeof g === "undefined" &&
        typeof b === "undefined" &&
        typeof i === "undefined" &&
        h === "H0001"
      ) {
        return;
      }
      h = step.util.σu8(h, false);
      var e = [b, f, d, c];
      var m = [g, b, h, j, f, d, k.createDefinition, c];
      step.util.σud(
        h,
        j,
        g,
        k.createDefinition,
        e,
        k.loadDefinitionFromRestAPI,
        m
      );
    } else {
      if (this.model.get("mode") === "analysis") {
        k.createAnalysis();
      } else {
        if (this.model.get("mode") === "history") {
          k.createHistory();
        } else {
          if (this.model.get("mode") === "color") {
            if ($("#ColorCode").length != 1) {
              k.createColor();
            }
          } else {
            k.createHelp();
          }
        }
      }
    }
    var l = 16;
    if (cv[l] !== undefined && cv[l] !== null) {
      cv[l] = 0;
    }
    return false;
  },
  loadDefinitionFromRestAPI: function (i) {
    var f = i[0];
    var b = i[1];
    var g = i[2];
    var h = i[3];
    var e = i[4];
    var d = i[5];
    var a = i[6];
    var c = i[7];
    $.getSafe(
      MODULE_GET_INFO,
      [f, b, g, h, step.userLanguageCode],
      function (j) {
        a(j, [b, e, d, c]);
      }
    ).error(function () {
      if (changeBaseURL()) {
        $.getSafe(
          MODULE_GET_INFO,
          [f, b, g, h, step.userLanguageCode],
          function (j) {
            a(j, [b, e, d, c]);
          }
        );
      }
    });
  },
  _createBaseTabs: function () {
    var b = $("<div class='tab-content'></div>");
    var a = $(".passageContainer.active").height();
    if (typeof a === "number") {
      a -= 60;
      a += "px";
    } else {
      a = "85vh";
    }
    this.lexicon = $(
      "<div id='lexicon' class='tab-pane' style='overflow-y:scroll;height:" +
        a +
        "'></div>"
    );
    this.analysis = $(
      "<div id='analysis' class='tab-pane' style='overflow-y:scroll;height:" +
        a +
        "'></div>"
    );
    this.history = $(
      "<div id='history' class='tab-pane' style='overflow-y:scroll;height:" +
        a +
        "'></div>"
    );
    this.color = $(
      "<div id='color' class='tab-pane' style='overflow-y:scroll;height:" +
        a +
        "'></div>"
    );
    this.help = $(
      "<div id='help' class='tab-pane' style='overflow-y:scroll;height:" +
        a +
        "'></div>"
    );
    b.append(this.lexicon);
    b.append(this.analysis);
    b.append(this.history);
    b.append(this.color);
    b.append(this.help);
    this.$el.append(b);
    return b;
  },
  createHistory: function () {
    if (!this.historyView) {
      this.historyView = new ViewHistory({
        el: this.history,
      });
    } else {
      this.historyView.refresh();
    }
  },
  createAnalysis: function () {
    if (!this.analysisView) {
      this.analysisView = new ViewLexiconWordle({
        el: this.analysis,
      });
    } else {
      this.analysisView.refresh();
    }
    if (step.touchDevice && !step.touchWideDevice) {
      this.closeSidebar();
      step.sidebar = null;
    }
  },
  createHelp: function () {
    this.helpView = new ExamplesView({
      el: this.help,
    });
  },
  createColor: function () {
    this.color = new ColorView({
      el: this.color,
    });
  },
  createDefinition: function (C, g) {
    var f = g[0];
    var w = g[1];
    var h = g[2];
    var F = g[3];
    var c;
    var y;
    if (!Array.isArray(h)) {
      h = [""];
    }
    if (this.lexicon.length == 1) {
      if (!Array.isArray(step.historyMorph)) {
        step.historyMorph = [];
      } else {
        if (step.historyMorph.length > 0) {
          c = step.historyMorph[step.historyMorph.length - 1];
        }
      }
      if (!Array.isArray(step.historyStrong)) {
        step.historyStrong = [];
      } else {
        if (step.historyStrong.length > 0) {
          y = step.historyStrong[step.historyStrong.length - 1];
        }
      }
    } else {
      console.log("this lexicon " + this.lexicon.length);
    }
    this.lexicon.detach();
    this.lexicon.empty();
    $("#quickLexicon").remove();
    var t = "h4";
    if (!step.touchDevice || step.touchWideDevice) {
      this.lexicon.append("<h1>");
      t = "h2";
    }
    if (C.vocabInfos.length == 0) {
      return;
    }
    var k = $.getUrlVar("lang");
    if (k == null) {
      k = "";
    } else {
      k = k.toLowerCase();
    }
    var E = step.userLanguageCode.toLowerCase();
    if (k == "zh_tw") {
      E = "zh_tw";
    } else {
      if (k == "zh") {
        E = "zh";
      }
    }
    var e = "";
    if (typeof f === "string") {
      if (step.util.σuI([f])[1]) {
        e = "OT";
      } else {
        e = "NT";
      }
    }
    var z = [];
    var b = "";
    if (
      lastMorphCode != "" &&
      C.morphInfos.length == 0 &&
      lastMorphCode.indexOf("TOS:") == 0
    ) {
      C.morphInfos = cf.getTOSMorphologyInfo(lastMorphCode);
    }
    if (C.vocabInfos.length > 1) {
      var v = $('<div class="panel-group" id="collapsedLexicon"></div>');
      for (var x = C.vocabInfos.length - 1; x > -1; x--) {
        var A = C.vocabInfos[x];
        var j = A.strongNumber;
        var a = j.substring(0, 1) === "H";
        var D = "lexicon-" + j;
        if (b !== "") {
          b += " ";
        }
        b += j;
        var q = A.stepGloss;
        if (E === "es") {
          q += " " + A._es_Gloss;
        } else {
          if (E === "zh") {
            q += " " + A._zh_Gloss;
          } else {
            if (E === "zh_tw") {
              q += " " + A._zh_tw_Gloss;
            } else {
              if (E === "km") {
                q += " " + A._km_Gloss;
              }
            }
          }
        }
        var n =
          "<span>" +
          q +
          " (<span class='transliteration'>" +
          A.stepTransliteration +
          '</span> - <span class="' +
          (a ? "hbFontSmall" : "unicodeFont") +
          '">' +
          A.accentedUnicode +
          "</span>)</span>";
        var u = x == 0 ? " in" : "";
        var o = $(
          '<div class="panel-collapse lexmodal ' + D + u + ' collapse">'
        );
        var m = $('<div class="panel-body"></div>');
        if (!step.touchDevice || step.touchWideDevice) {
          o.append(m);
        }
        this._createBriefWordPanel(m, A, E, w, f);
        var l = h[x];
        if (typeof l !== "string" && typeof h[0] === "string") {
          l = h[0];
        }
        if (typeof l === "string" && l !== "") {
          m.append("<div>in " + l + " manuscript</div>");
        }
        if (x < C.morphInfos.length) {
          this._createBriefMorphInfo(m, C.morphInfos[x]);
        }
        this._createWordPanel(m, A, E, w, e, t, C.morphInfos[x]);
        if (x < C.morphInfos.length) {
          this._createMorphInfo(m, C.morphInfos[x], t);
        }
        m.append(
          $(
            "<br><a onclick=\"javascript:step.util.σuAG('" +
              j +
              "','" +
              f +
              "','" +
              w +
              '\')" title="Report lexicon issues">Report lexicon issues</a>'
          )
        );
        z.push(m);
        var s =
          '<div class="panel-heading"><h4 class="panel-title" data-toggle="collapse" data-parent="#collapsedLexicon" data-target=".' +
          D +
          '"><a>' +
          n;
        if (x > 0) {
          s += '<span class="clicktoview"> (click to view)</span>';
        }
        s += "</a></h4></div>";
        var p = $(
          '<div class="panel panel-default" style="background:var(--clrBackground)"></div>'
        )
          .append(s)
          .append(o);
        v.append(p);
      }
      this.lexicon.append(v);
      var d = 6000;
      if (typeof step.shownClick === "number") {
        step.shownClick++;
        d = Math.max(d - step.shownClick * 300, 1500);
      } else {
        step.shownClick = 1;
      }
      setTimeout(function () {
        $(".clicktoview").remove();
      }, d);
    } else {
      b += C.vocabInfos[0].strongNumber;
      var m = $('<div class="panel-body"></div>');
      this._createBriefWordPanel(m, C.vocabInfos[0], E, w, f);
      if (h[0] !== "") {
        m.append("<div>Only in " + h[0] + " manuscript</div>");
      }
      if (C.morphInfos.length > 0) {
        this._createBriefMorphInfo(
          m,
          C.morphInfos[0],
          F,
          f,
          C.vocabInfos[0].strongNumber
        );
      }
      this._createWordPanel(m, C.vocabInfos[0], E, w, e, t, C.morphInfos[0]);
      if (C.morphInfos.length > 0) {
        this._createMorphInfo(m, C.morphInfos[0], t);
      }
      m.append(
        $(
          "<br><a onclick=\"javascript:step.util.σuAG('" +
            C.vocabInfos[0].strongNumber +
            "','" +
            f +
            "','" +
            w +
            '\')" title="Report lexicon issues">Report lexicon issues</a>'
        )
      );
      if (step.touchDevice && !step.touchWideDevice) {
        z.push(m);
      } else {
        this.lexicon.append(m);
      }
    }
    if (this.lexicon.length == 1) {
      step.historyMorph.push(lastMorphCode);
      step.historyStrong.push(b);
    } else {
      console.log("this.lexicon length is " + this.lexicon.length);
    }
    if (typeof y === "string" && y !== b) {
      var B = $(this.lexicon[0]);
      B.prepend(
        "<button id='lexicon-back-button' class='glyphicon glyphicon-arrow-left' title='Back to the definition of the previous word, " +
          y +
          "'></button>"
      );
    }
    if (step.touchDevice && !step.touchWideDevice) {
      step.util.σuu(this.lexicon.html(), "<b>" + __s.lexicon_vocab + "</b>", z);
      this.closeSidebar();
      step.sidebar = null;
    } else {
      this.lexicon.find("h1").text(__s.lexicon_vocab);
      this.tabContainer.append(this.lexicon);
    }
    this._initExpandCollapse("detailLex");
    this._initExpandCollapse("LSJLexicon");
    this._initExpandCollapse("GeneralRelatedWords");
    this._initExpandCollapse("GrammarInfo");
    this._isItALocation(C.vocabInfos[0], f);
    this._isItAPerson(C.vocabInfos[0]);
    var r = $("#lexicon-back-button");
    if (r.length != 1) {
      return;
    }
    r.click(function () {
      if (step.historyMorph.length > 2) {
        step.historyMorph.pop();
        step.historyMorph.pop();
      } else {
        step.historyMorph = [];
      }
      if (step.historyStrong.length > 2) {
        step.historyStrong.pop();
        step.historyStrong.pop();
      } else {
        step.historyStrong = [];
      }
      var i = y.split(" ").reverse().join(" ");
      step.util.ui.σiJ({
        strong: i,
        morph: c,
        version: w.split(" ")[0],
      });
    });
  },
  _initExpandCollapse: function (a) {
    if (
      $("." + a + ":visible").length > 0 ||
      step.util.σuM("sidebar." + a) === "true"
    ) {
      $("." + a).show();
      $("." + a + "Select")
        .removeClass("glyphicon-triangle-right")
        .addClass("glyphicon-triangle-bottom");
    }
  },
  _createBriefWordPanel: function (b, c, f, e, d) {
    var g = "";
    if (f == "es" && c._es_Gloss != undefined) {
      g = "&nbsp;" + c._es_Gloss + "&nbsp;";
    } else {
      if (f == "zh" && c._zh_Gloss != undefined) {
        g = "&nbsp;" + c._zh_Gloss + "&nbsp;";
      } else {
        if (f == "zh_tw" && c._zh_tw_Gloss != undefined) {
          g = "&nbsp;" + c._zh_tw_Gloss + "&nbsp;";
        } else {
          if (f == "km" && c._km_Gloss != undefined) {
            g = "&nbsp;" + c._km_Gloss + "&nbsp;";
          }
        }
      }
    }
    var a = c.strongNumber;
    b.append(
      $("<div>")
        .append(
          $("<span>")
            .addClass(a[0] === "H" ? "hbFontSmall" : "unicodeFont")
            .append(c.accentedUnicode)
        )
        .append(" (")
        .append(
          "<span class='transliteration'>" + c.stepTransliteration + "</span>"
        )
        .append(") ")
        .append(c.stepGloss)
        .append(" ")
        .append("<span class='side_gloss_" + a + "'>" + g + "</span> ")
        .append(
          $(" <span title='" + __s.strong_number + "'>")
            .append(" (" + c.strongNumber + ")")
            .addClass("strongNumberTagLine")
        )
        .append(
          '<span class="possibleMap' +
            c.strongNumber +
            '"></span><span class="possiblePerson' +
            c.strongNumber +
            '"></span>'
        )
    );
  },
  _addLinkAndAppend: function (b, j, e, h, a) {
    var p = j;
    var k = p;
    var o = p.search("<ref=['\"]");
    if (o > -1) {
      k = "";
      while (o > -1) {
        k += p.substr(0, o);
        var g = p.substr(o + 5, 1);
        p = p.substr(o + 6);
        var n = p.search(g + ">");
        if (n > 2) {
          var i = p.substr(0, n);
          p = p.substr(n + 2);
          var l = p.indexOf("</ref>");
          if (l > -1) {
            k +=
              "<a sbRef=" +
              g +
              i +
              g +
              ' class="linkRef" href="?q=version=' +
              h +
              "&amp;reference=" +
              i +
              '">' +
              p.substr(0, l) +
              "</a>";
            p = p.substr(l + 6);
            o = p.search("<ref=['\"]");
          } else {
            k += "<ref=" + g + i + g + ">" + p;
            p = "";
            o = -1;
          }
        } else {
          k += "<ref=" + g + p;
          p = "";
          o = -1;
        }
      }
      k += p;
    }
    if (a) {
      var c = k.split("<br>");
      var m = $("<ul>");
      for (var d = 0; d < c.length; d++) {
        var f = $("<li>");
        this._addLinkToStrongWord(f, c[d], e);
        m.append(f);
      }
      b.append(m);
    } else {
      this._addLinkToStrongWord(b, k, e);
    }
  },
  _addLinkToStrongWord: function (h, j, a) {
    var k = new RegExp(/[GH]\d{4,5}[a-zA-Z]?/g);
    var b = j.match(k);
    if (b != null) {
      for (var e = 0; e < b.length; e++) {
        var g = j.search(b[e]);
        var d = b[e].length;
        var f = j.substr(g, d);
        var c = f;
        if (c.substr(0, 1) != "G" && c.substr(0, 1) != "H") {
          c = a + f;
        }
        if (c.length == 6 && c.substr(1, 1) == "0" && !isNaN(c.substr(2, 5))) {
          c = c.substr(0, 1) + c.substr(2);
        }
        h.append(j.substr(0, g));
        h.append(
          $('<a sbstrong href="javascript:void(0)">')
            .append(f)
            .data("strongNumber", c)
        );
        j = j.substr(g + d);
      }
    }
    h.append(j).append("<br />");
  },
  _addChineseDefinitions: function (b, c, h, e, g) {
    var f = c.strongNumber.substr(0, 1);
    var a = false;
    $.ajaxSetup({
      async: false,
    });
    var d = c.strongNumber;
    if (d.search(/([GH])(\d{1,4})[A-Za-z]?$/) > -1) {
      d = RegExp.$1 + ("000" + RegExp.$2).slice(-4);
    }
    $.getJSON("/lexicon/" + h + "/" + d + ".json", function (s) {
      a = true;
      b.append($("<h2>").append(__s.zh_lexicon_chinese_name + ":"));
      b.append(
        $("<h2>").append(
          __s.lexicon_part_of_speech_for_zh +
            ':&nbsp;<span style="font-weight:normal;font-size:14px">' +
            s.partOfSpeech +
            "</span>"
        )
      );
      b.append($("<h2>").append(__s.lexicon_definition_for_zh + ":"));
      g(b, s.definition, f, e);
      b.append($("<h2>").append(__s.lexicon_usage_for_zh + ":"));
      var q = $("<ul>");
      for (var p = 0; p < s.usage.length; p = p + 2) {
        var v = $("<li></li>");
        var l = s.usage[p];
        var t = s.usage[p + 1];
        if (t.length > 1) {
          v.append(
            '<span><abbr title="Over 100 usage of this word.  Each of the following link will display about 100 usage.">' +
              l +
              "</abbr></span>"
          );
        }
        for (var o = 0; o < t.length; o++) {
          var n = "";
          var r = t[o];
          for (var m = 0; m < r.length; m++) {
            n += URL_SEPARATOR + "reference=" + r[m];
          }
          if (t.length > 1) {
            var u = "";
            if (o / 26 >= 1) {
              u = String.fromCharCode(97 + Math.floor(o / 26) - 1);
            }
            u += String.fromCharCode(97 + (o % 26));
            l =
              '&nbsp;<span title="Usage ' +
              (1 + o * 100) +
              " to " +
              (100 + o * 100) +
              '">(' +
              u +
              ")</span>";
          }
          v.append(
            $("<a sbstrong></a>")
              .attr("href", "javascript:void(0)")
              .data("strongNumber", d)
              .data("refURLStr", n)
              .append(l)
              .click(function () {
                var k = $(this).data("strongNumber");
                var j = $(this).data("refURLStr");
                var i = "strong=" + encodeURIComponent(k) + j;
                step.util.σuQ().save(
                  {
                    strongHighlights: k,
                  },
                  {
                    silent: true,
                  }
                );
                step.router.σmC(i, false, true);
                step.util.closeModal("showLongAlertModal");
              })
          );
        }
        q.append(v);
      }
      b.append(q);
    });
    $.ajaxSetup({
      async: true,
    });
    return a;
  },
  _addDetailLexicalWords: function (m, a, h, o, c, g, i, f) {
    var l = parseInt(m[3]);
    a.append($("<br class='detailLex' style='display:none'>"));
    var b = "&nbsp;&nbsp;&nbsp;";
    if (h) {
      a.append(
        $(
          "<span class='detailLex glyphicon glyphicon-arrow-right' style='font-size:10px;display:none' ></span>"
        )
      );
      b = "";
    }
    var k = $(
      "<a class='detailLex' style='display:none'>" + b + m[0] + " </a>"
    );
    step.searchSelect.σsp("strong", m[1], "", f, k);
    k.data("strongNumber", m[1]).click(function () {
      step.util.ui.σiJ($(this).data("strongNumber"), f);
    });
    a.append(k);
    a.append(
      $(
        "<span class='detailLex' style='display:none' title='" +
          m[1] +
          " " +
          m[4] +
          "'>" +
          m[2] +
          "</span>"
      )
    );
    a.append(
      $('<span class="detailLex" style="display:none">&nbsp;&nbsp;</span>')
    );
    var e = step.util.σuAF(
      {
        versionCountOT: o,
        versionCountNT: c,
      },
      l,
      g
    );
    var j = m[1].substring(0, 1) === "H";
    var n =
      m[2] +
      " (<span class='transliteration'>" +
      m[5] +
      '</span> - <span class="' +
      (j ? "hbFontSmall" : "unicodeFont") +
      '">' +
      m[4] +
      "</span>)";
    a.append(
      $("<a title='" + __s.click_to_show_all + "'></a>")
        .attr("onclick", "javascript:void(0)")
        .data("strongNumber", m[1])
        .data("vocabTitle", n)
        .append(
          '<span class="strongCount detailLex" style="unicode-bidi:normal;display:none">~' +
            e +
            "</span>"
        )
        .click(function () {
          var q = $(this).data("strongNumber");
          var p = "strong=" + encodeURIComponent(q);
          step.util.σuQ().save(
            {
              strongHighlights: q,
            },
            {
              silent: true,
            }
          );
          step.router.σmC(p, false, true);
          step.util.closeModal("showLongAlertModal");
          return false;
        })
        .hover(
          function (r) {
            if (step.touchDevice) {
              return;
            }
            var p = $(this).data("strongNumber");
            var q = $(this).data("vocabTitle");
            fetch(
              "https://www.stepbible.org/rest/search/masterSearch/version=ESV|strong=" +
                p +
                "/HNVUG///" +
                p +
                "///en?lang=en"
            )
              .then(function (s) {
                return s.json();
              })
              .then(function (s) {
                step.util.ui.σib(s, r.pageY, q, $("#columHolder"));
              });
          },
          function () {
            if (step.touchDevice) {
              return;
            }
            $("#quickLexicon").remove();
          }
        )
    );
    if (!step.state.isLocal()) {
      a.append("&nbsp;&nbsp;");
      var d = step.util.σMY(m[1], m[6], i, m[4], m[5], "detailLex");
      a.append(d);
    }
  },
  _composeDescriptionOfOccurrences: function (a) {
    if (a === "person or group") {
      a = "person_or_group";
    }
    if (
      typeof a !== "string" ||
      typeof __s["type_of_word_" + a] !== "string" ||
      (step.userLanguage !== "English" &&
        __s.type_of_word_frequency === "This %s occurs about")
    ) {
      return __s.lexicon_search_for_this_word;
    }
    return sprintf(__s.type_of_word_frequency, __s["type_of_word_" + a]);
  },
  _appendLexiconSearch: function (m, l, e, p, s) {
    var w = l.count;
    var v = 0;
    var n = 0;
    var t = [];
    var h = [];
    var r = [];
    m.append("<br />").append(
      this._composeDescriptionOfOccurrences(l._step_Type)
    );
    if (e && e.length > 0) {
      r.push(l.strongNumber);
      for (var q = 0; q < e.length; q++) {
        w += parseInt(e[q][3]);
        if (e[q][1] !== l.strongNumber) {
          r.push(e[q][1]);
          var f = {
            vocabInfos: [
              {
                strongNumber: e[q][1],
                freqList: e[q][6],
              },
            ],
          };
        } else {
          f = {
            vocabInfos: [l],
          };
        }
        step.util.σun(f, p);
        var o =
          typeof f.vocabInfos[0].versionCountOT === "number"
            ? f.vocabInfos[0].versionCountOT
            : 0;
        var k =
          typeof f.vocabInfos[0].versionCountNT === "number"
            ? f.vocabInfos[0].versionCountNT
            : 0;
        v += o;
        n += k;
        t.push(o);
        h.push(k);
      }
      var c = v > 0 && n > 0;
      var g = step.util.σuAF(
        {
          versionCountOT: v,
          versionCountNT: n,
        },
        w,
        c
      );
      m.append(
        $("<a></a>")
          .attr("href", "javascript:void(0)")
          .data("strongNumber", r)
          .append(
            '<span class="strongCount" style="unicode-bidi:normal"> ' +
              g +
              "</span>"
          )
          .click(function () {
            var x = $(this).data("strongNumber");
            var z = "strong=" + encodeURIComponent(x[0]);
            var A = "";
            for (var y = 1; y < r.length; y++) {
              z += URL_SEPARATOR + "strong=" + encodeURIComponent(x[y]);
              if (y == 1) {
                A = "srchJoin=(1o2";
              } else {
                A += "o" + (y + 1);
              }
            }
            if (r.length > 1) {
              z = A + ")" + URL_SEPARATOR + z;
            }
            step.router.σmC(z, false, true, true);
            step.util.closeModal("showLongAlertModal");
            return false;
          })
          .hover(function () {
            $("#quickLexicon").remove();
          })
      );
      m.append(
        $(
          "<a class='glyphicon glyphicon-triangle-right detailLexSelect'></a>"
        ).click(step.util.expandCollapse)
      );
      for (var q = 0; q < e.length; q++) {
        this._addDetailLexicalWords(
          e[q],
          m,
          e[q][1] === l.strongNumber,
          t[q],
          h[q],
          c,
          p,
          s
        );
      }
    } else {
      var u = {
        vocabInfos: [l],
      };
      step.util.σun(u, p);
      var j = step.util.σuAF(l, w, false);
      if (j !== "") {
        var a = l.strongNumber.substring(0, 1) == "H";
        var b =
          l.stepGloss +
          " (<span class='transliteration'>" +
          l.stepTransliteration +
          '</span> - <span class="' +
          (a ? "hbFontSmall" : "unicodeFont") +
          '">' +
          l.accentedUnicode +
          "</span>)";
        m.append(
          $("<a></a>")
            .attr("href", "javascript:void(0)")
            .data("strongNumber", l.strongNumber)
            .data("vocabTitle", b)
            .append('<span class="strongCount"> ' + j + "</span>")
            .click(function () {
              var x = $(this).data("strongNumber");
              var i = "strong=" + encodeURIComponent(x);
              step.util.σuQ().save(
                {
                  strongHighlights: x,
                },
                {
                  silent: true,
                }
              );
              step.router.σmC(i, false, true);
              step.util.closeModal("showLongAlertModal");
              return false;
            })
            .hover(
              function (y) {
                if (step.touchDevice) {
                  return;
                }
                var i = $(this).data("strongNumber");
                var x = $(this).data("vocabTitle");
                fetch(
                  "https://www.stepbible.org/rest/search/masterSearch/version=ESV|strong=" +
                    i +
                    "/HNVUG///" +
                    i +
                    "///en?lang=en"
                )
                  .then(function (z) {
                    return z.json();
                  })
                  .then(function (z) {
                    step.util.ui.σib(z, y.pageY, x, $("#columHolder"));
                  });
              },
              function () {
                if (step.touchDevice) {
                  return;
                }
                $("#quickLexicon").remove();
              }
            )
        );
        if (!step.state.isLocal()) {
          m.append("&nbsp;&nbsp;");
          var d = step.util.σMY(l.strongNumber, l.freqList, p, "", "");
          m.append(d);
        }
      }
    }
    m.append().append("<br />");
    return false;
  },
  _lookUpGeoInfo: function (a, b, d) {
    b = b.substring(0, b.length - 1);
    var c = $(".possibleMap" + a.strongNumber);
    if (c.length == 0) {
      console.log("cannot find possible Map ID in html");
      c = $(".possibleMap" + a.strongNumber);
    }
    c.empty().html(
      "<a href='/html/multimap.html?coord=" +
        d +
        "&strong=" +
        a.strongNumber +
        "&gloss=" +
        a.stepGloss +
        "&book=" +
        b +
        "' target='_new'><button type='button' class='stepButton' ><b>Map</b></button></a>"
    );
  },
  _relatedNosNotDisplayed: function (b, a) {
    if (typeof b === "string") {
      b = JSON.parse(b.replaceAll("'", '"'));
    }
    var f = [];
    if (b) {
      for (var d = 0; d < b.length; d++) {
        var e = false;
        for (var c = 0; c < a.length && !e; c++) {
          if (b[d].strongNumber === a[c][1]) {
            e = true;
          }
        }
        if (!e) {
          f.push(b[d]);
        }
      }
    }
    return f;
  },
  _isItALocation: function (e, g) {
    var b = e.strongNumber.trim();
    var d = e._step_Link;
    if (typeof d !== "string") {
      return;
    }
    var d = d.trim();
    if (d.length < 3 || isNaN(d.substring(0, 1))) {
      return;
    }
    var c = d.indexOf(",");
    if (c == -1) {
      return;
    }
    if (isNaN(d.substring(0, c - 1)) || isNaN(d.substring(c + 1))) {
      return;
    }
    if (typeof g === "undefined") {
      if (
        typeof step.previousSideBarLexiconRef === "object" &&
        (b === step.previousSideBarLexiconRef[0] ||
          b.substring(0, b.length - 1) === step.previousSideBarLexiconRef[0])
      ) {
        g = step.previousSideBarLexiconRef[1];
      } else {
        g = "";
      }
    } else {
      step.previousSideBarLexiconRef = [b, g];
    }
    var a = g.indexOf(".");
    var f = a > 2 ? g.substr(0, a + 1) : "";
    this._lookUpGeoInfo(e, f, d);
  },
  _prepIndentNTDef: function (d) {
    var e = d.split(/<ref/i);
    var g = e[0].indexOf(";");
    var f = false;
    if (g > -1) {
      e[0] = e[0].replace(/;/g, ";<br>");
      f = true;
    }
    for (var b = 1; b < e.length; b++) {
      partsInRef = e[b].split("</ref>");
      if (partsInRef.length > 2) {
        console.log(
          "more than 2 parts " + b + " " + e[b] + " " + mainWord.mediumDef
        );
        continue;
      }
      if (partsInRef.length == 2) {
        var g = partsInRef[1].indexOf(";");
        if (g > -1) {
          if (partsInRef[1].trim().length > 1) {
            e[b] =
              partsInRef[0] + "</ref>" + partsInRef[1].replace(/;/g, ";<br>");
            f = true;
          }
        }
      }
    }
    if (f) {
      var a = "";
      for (var c = 0; c < e.length; c++) {
        if (c > 0) {
          a += "<ref";
        }
        a += e[c];
      }
      return [
        f,
        a
          .replace(/<br \/>/gi, "<br>")
          .replace(/<br>\s*<br>/gi, "<br>")
          .replace(/<br>\s*<br>/gi, "<br>"),
      ];
    }
    return [f, d];
  },
  _indentOTDefinition: function (b, d) {
    var k = b.split(/<br>/i);
    var f = "";
    var h = "";
    for (var e = 0; e < k.length; e++) {
      var g = false;
      if (d !== "" && k[e].indexOf(d) > -1) {
        g = true;
      }
      var j = k[e].indexOf(")");
      var a = false;
      var c = 0;
      if (
        j > 1 &&
        j < 6 &&
        !isNaN(k[e].charAt(0)) &&
        k[e].substring(0, j).indexOf("(") == -1
      ) {
        if (g) {
          h = k[e].substring(0, j);
        } else {
          if (h !== "" && k[e].indexOf(h) == 0) {
            a = true;
          }
        }
        c = (j - 1) * 8;
      }
      if (g || a) {
        k[e] = "<b>" + k[e] + "</b>";
      }
      f +=
        '<p style="margin-bottom:0px;margin-left:' + c + 'px">' + k[e] + "</p>";
    }
    return f;
  },
  _createWordPanel: function (o, m, J, z, e, x, a) {
    var n = m.strongNumber[0];
    var B = this.model.get("version") || "ESV";
    var A = "";
    if (typeof m.shortDefMounce === "string") {
      if (
        typeof m.mediumDef !== "string" ||
        m.shortDefMounce.length < 3 ||
        m.mediumDef.indexOf(m.shortDefMounce) == -1
      ) {
        A = m.shortDefMounce;
      }
    }
    if (typeof m.shortDef === "string") {
      if (
        typeof m.mediumDef !== "string" ||
        m.shortDef.length < 3 ||
        m.mediumDef.indexOf(m.shortDef) == -1
      ) {
        if (A === "") {
          A = m.shortDef;
        } else {
          A += "<br>" + m.shortDef;
        }
      }
    }
    if (m.briefDef && typeof m.briefDef === "string") {
      if (A === "") {
        A = m.briefDef;
      } else {
        A += "<br>" + m.briefDef;
      }
    }
    if (A !== "") {
      this._addLinkAndAppend(o, A, n, B, true);
    }
    var b = [];
    if (m._stepDetailLexicalTag) {
      b =
        typeof m._stepDetailLexicalTag === "string"
          ? JSON.parse(m._stepDetailLexicalTag)
          : m._stepDetailLexicalTag;
    }
    this._appendLexiconSearch(o, m, b, z, B);
    var C = true;
    var G = false;
    if (J.indexOf("es") == 0) {
      var k = m._es_Definition;
      if (k) {
        o.append(
          $("<" + x + " style='margin-top:8px'>").append(__s.es_lexicon_meaning)
        );
        this._addLinkAndAppend(o, k, n, B);
      }
    } else {
      if (J.indexOf("zh") == 0) {
        C =
          step.passages
            .findWhere({
              passageId: step.util.σuP(),
            })
            .get("isEnWithZhLexicon") || false;
        var r;
        if (J == "zh_tw" && m._zh_tw_Definition != undefined) {
          r = m._zh_tw_Definition;
        } else {
          if (m._zh_Definition != undefined) {
            r = m._zh_Definition;
          }
        }
        if (r) {
          o.append(
            $("<" + x + " style='margin-top:8px'>").append(
              __s.zh_lexicon_meaning_fhl
            )
          );
          this._addLinkAndAppend(o, r, n, B);
        }
        var d = step.passages
          .findWhere({
            passageId: step.util.σuP(),
          })
          .get("isSecondZhLexicon");
        if (d) {
          G = this._addChineseDefinitions(o, m, J, B, this._addLinkAndAppend);
        }
      } else {
        if (J == "vi") {
          var D = m._vi_Definition;
          if (D) {
            o.append(
              $("<" + x + " style='margin-top:8px'>").append(
                "Từ điển Hy Lạp-Việt"
              )
            );
            this._addLinkAndAppend(o, D, n, B);
          }
        } else {
          if (J == "km") {
            var w = m._km_Definition;
            if (w) {
              o.append(
                $("<" + x + " style='margin-top:8px'>").append("និយមន័យ")
              );
              this._addLinkAndAppend(o, w, n, B);
            }
          }
        }
      }
    }
    var c = m.strongNumber.charAt(0);
    if (step.defaults.langWithTranslatedLex.indexOf(J) > -1) {
      var h = c === "G" ? this._prepIndentNTDef : this._indentOTDefinition;
      var f = this._addLinkAndAppend;
      var v = this.addStrongTriggers;
      fetch(
        "https://us.stepbible.org/html/lexicon/" +
          J +
          "_json/" +
          m.strongNumber +
          ".json"
      )
        .then(function (i) {
          return i.json();
        })
        .then(function (M) {
          var N = M.gloss;
          var O = N.indexOf(":");
          if (O > -1) {
            N = N.substring(O + 1);
          }
          step.util.σMR(".side_gloss_" + M.strong, "[" + N.trim() + "]", 0);
          if (!isNaN(M.page)) {
            var i = M.page + 14;
            o.append(
              '<a href="https://gallica.bnf.fr/ark:/12148/bpt6k6507608z/f' +
                i +
                '.item" target="_blank">Dictionnaire hébreu-français...</a>'
            )
              .append("&nbsp;&nbsp;")
              .append(
                '<a style="font-size:14px" class="glyphicon glyphicon-picture" href="https://gallica.bnf.fr/ark:/12148/bpt6k6507608z/f' +
                  i +
                  '.highres" target="_blank"></a>'
              )
              .append("<br>");
          }
          o.append(
            $("<" + x + " style='margin-top:8px'>").append(
              __s.meaning + " (Google translate)"
            )
          );
          var L = h(M.def);
          var K = false;
          if (M.strong.charAt(0) === "G") {
            L = L[1];
            K = L[0];
          }
          f(o, L, n, B, K);
          v(o, B);
        });
    }
    if (C) {
      if (m.mediumDef) {
        var l = "";
        if (e === "OT") {
          l = "based on abridged Brown-Driver-Briggs";
        } else {
          if (e === "NT") {
            l = "based on Teknia Greek";
          }
        }
        o.append(
          $("<" + x + " style='margin-top:8px' title='" + l + "'>").append(
            __s.lexicon_meaning
          )
        );
        var u = false;
        if (c === "H") {
          var j = "";
          if (typeof a === "object" && typeof a.stem === "string") {
            j =
              "(" + a.stem.charAt(0).toUpperCase() + a.stem.substring(1) + ")";
          }
          m.mediumDef = this._indentOTDefinition(m.mediumDef, j);
        } else {
          if (c === "G") {
            var t = this._prepIndentNTDef(m.mediumDef);
            u = t[0];
            m.mediumDef = t[1];
          }
        }
        this._addLinkAndAppend(o, m.mediumDef, n, B, u);
      }
      if (m.lsjDefs) {
        o.append(
          $(
            "<" +
              x +
              " style='margin-top:8px' title='based on Liddell-Scott-Jones Greek Lexicon, 9th ed'>"
          )
            .append(
              n.toLowerCase() === "g"
                ? __s.lexicon_lsj_definition
                : __s.lexicon_bdb_definition
            )
            .append(
              $(
                "<a style='font-size:14px' class='glyphicon glyphicon-triangle-right LSJLexiconSelect'></a>"
              ).click(step.util.expandCollapse)
            )
        );
        o.append(
          '<span class="LSJLexicon unicodefont" style="display:none">' +
            m.lsjDefs +
            "</span>"
        );
      }
    }
    relatedNosToDisplay = this._relatedNosNotDisplayed(m.relatedNos, b);
    if (relatedNosToDisplay.length > 0) {
      o.append(
        $("<" + x + " style='margin-top:8px'>")
          .append(__s.lexicon_related_words)
          .append(
            $(
              "<a style='font-size:14px' class='glyphicon glyphicon-triangle-right GeneralRelatedWordsSelect'></a>"
            ).click(step.util.expandCollapse)
          )
      );
      var q = $('<ul class="GeneralRelatedWords" style="display:none">');
      var H = "";
      for (var y = 0; y < relatedNosToDisplay.length; y++) {
        var I = relatedNosToDisplay[y].strongNumber;
        if (I != m.strongNumber) {
          var s = "";
          var g = relatedNosToDisplay[y].gloss;
          if (J == "es" && relatedNosToDisplay[y]._es_Gloss != undefined) {
            s = " [" + relatedNosToDisplay[y]._es_Gloss + "]";
          } else {
            if (J == "zh" && relatedNosToDisplay[y]._zh_Gloss != undefined) {
              s = " [" + relatedNosToDisplay[y]._zh_Gloss + "]";
            } else {
              if (
                J == "zh_tw" &&
                relatedNosToDisplay[y]._zh_tw_Gloss != undefined
              ) {
                s = " [" + relatedNosToDisplay[y]._zh_tw_Gloss + "]";
              } else {
                if (
                  J == "km" &&
                  relatedNosToDisplay[y]._km_Gloss != undefined
                ) {
                  s = " [" + relatedNosToDisplay[y]._km_Gloss + "]";
                } else {
                  if (step.defaults.langWithTranslatedLex.indexOf(J) > -1) {
                    s =
                      " <span class='rel_gloss_" +
                      relatedNosToDisplay[y].strongNumber +
                      "'></span>";
                  }
                }
              }
            }
          }
          var p = "";
          if (
            !relatedNosToDisplay[y]._searchResultRange ||
            relatedNosToDisplay[y]._searchResultRange === ""
          ) {
            var F = "";
            var E = I.substr(0, 1).toLowerCase();
            if (E === "h") {
              F = "hbFontMini";
            } else {
              if (E === "g") {
                F = "unicodeFont";
              }
            }
            p = $("<li title='" + I + "'></li>").append(
              $('<a sbstrong onclick="javascript:void(0)">')
                .append(g)
                .append(s)
                .append(" (")
                .append(
                  "<span class='transliteration'>" +
                    relatedNosToDisplay[y].stepTransliteration +
                    "</span>"
                )
                .append(" - ")
                .append(
                  "<span class='" +
                    F +
                    "'>" +
                    relatedNosToDisplay[y].matchingForm +
                    "</span>"
                )
                .append(")")
                .data("strongNumber", I)
            );
          } else {
            p = $(
              "<li title='" +
                relatedNosToDisplay[y].strongNumber +
                " " +
                relatedNosToDisplay[y].stepTransliteration +
                " " +
                relatedNosToDisplay[y].matchingForm +
                "'></li>"
            ).append(
              $('<a sbstrong onclick="javascript:void(0)">')
                .append(g)
                .append(s)
                .append(
                  step.util.σu6(
                    relatedNosToDisplay[y]._searchResultRange,
                    false
                  )
                )
                .data("strongNumber", I)
            );
          }
          q.append(p);
          H += relatedNosToDisplay[y].strongNumber + " ";
          if (step.defaults.langWithTranslatedLex.indexOf(J) > -1) {
            fetch(
              "https://us.stepbible.org/html/lexicon/" +
                J +
                "_json/" +
                I +
                ".json"
            )
              .then(function (i) {
                return i.json();
              })
              .then(function (i) {
                var K = i.gloss;
                var L = K.indexOf(":");
                if (L > -1) {
                  K = K.substring(L + 1);
                }
                step.util.σMR(
                  ".rel_gloss_" + i.strong,
                  "[" + K.trim() + "]",
                  0
                );
              });
          }
        }
      }
      step.passage.σuD(null, H, "lexiconRelatedFocus");
      o.append(q);
    }
    this.addStrongTriggers(o, B);
    if (G && !step.state.isLocal()) {
      o.append(
        '<br><a href="lexicon/additionalinfo/' +
          m.strongNumber +
          '.html" target="_blank">' +
          __s.zh_additional_zh_lexicon_info +
          "</a>"
      );
    }
    this.σMM(o, B);
  },
  addStrongTriggers: function (a, b) {
    a.find("[sbstrong]").click(function () {
      step.util.ui.σiJ($(this).data("strongNumber"), b);
    });
    if (!step.touchDevice) {
      a.find("[sbstrong]").hover(
        function (d) {
          if (d.type === "mouseleave") {
            $("#quickLexicon").remove();
            return;
          }
          var c = $(this).data("strongNumber");
          require(["quick_lexicon"], function () {
            step.util.delay(
              function () {
                step.util.ui.σiQ(
                  c,
                  "",
                  "",
                  b,
                  step.util.σuP(),
                  d,
                  d.pageY,
                  null,
                  ""
                );
              },
              MOUSE_PAUSE,
              "show-quick-lexicon"
            );
          });
        },
        function () {
          step.util.delay(undefined, 0, "show-quick-lexicon");
          $("#quickLexicon").remove();
        }
      );
    }
  },
  _createBriefMorphInfo: function (c, g, h, f, a) {
    if (typeof g === "undefined" || Object.keys(g).length === 0) {
      return;
    }
    c.append("(");
    if (g.ot_function === undefined) {
      this.renderBriefMorphItem(c, g, "function");
    } else {
      this.renderBriefMorphItem(c, g, "ot_function");
    }
    this.renderBriefMorphItem(c, g, "tense");
    this.renderBriefMorphItem(c, g, "voice");
    this.renderBriefMorphItem(c, g, "mood");
    this.renderBriefMorphItem(c, g, "stem");
    this.renderBriefMorphItem(c, g, "ot_form");
    this.renderBriefMorphItem(c, g, "wordCase");
    this.renderBriefMorphItem(c, g, "person");
    this.renderBriefMorphItem(c, g, "number");
    this.renderBriefMorphItem(c, g, "gender");
    this.renderBriefMorphItem(c, g, "state");
    this.renderBriefMorphItem(c, g, "suffix");
    var e = c.contents();
    if (e.length) {
      var d = e.get(e.length - 1);
      if (d.nodeType === 3) {
        d.nodeValue = d.nodeValue.replace(/\s+$/, "");
        if (d.nodeValue.length === 0) {
          $(d).remove();
        }
      }
    }
    c.append(")");
    if (h > 1) {
      if (
        typeof f === "string" &&
        f !== "" &&
        typeof a === "string" &&
        (a.substring(0, 1) === "G" || a.substring(0, 1) === "H")
      ) {
        c.append(" - 1st of ");
        var b = a.substring(0, 1) === "G" ? "THGNT" : "OHB";
        a = step.util.σu8(a, true);
        c.append(
          "<a href='https://www.stepbible.org/?q=version=" +
            b +
            URL_SEPARATOR +
            "reference=" +
            f +
            URL_SEPARATOR +
            "strong=" +
            a +
            "&clickStrong' target='_blank'>" +
            h +
            " different grammars</a>"
        );
      } else {
        c.append(" - 1st of " + h + "  different grammars");
      }
      c.append(" for this word in this verse.");
    }
    c.append("<br />");
  },
  renderBriefMorphItem: function (a, e, d) {
    if (e && d && e[d]) {
      var f = this.replaceEmphasis(e[d]);
      var c = f.toLowerCase().replace(/ /g, "_");
      if (
        typeof __s[c] !== "undefined" &&
        f.toLowerCase() !== __s[c].toLowerCase()
      ) {
        f += " (" + __s[c] + ") ";
      }
      var b = $("<span>" + f + "</span>");
      a.append(b);
      a.append(" ");
    }
  },
  _createMorphInfo: function (b, c, a) {
    if (typeof c === "undefined") {
      b.append("<br />");
      return;
    }
    b.append(
      $("<" + a + " style='margin-top:8px'>")
        .append(__s.display_grammar)
        .append(
          $(
            "<a style='font-size:14px' class='glyphicon glyphicon-triangle-right GrammarInfoSelect'></a>"
          ).click(step.util.expandCollapse)
        )
    );
    this.renderMorphItem(b, c, __s.lexicon_grammar_language, "language");
    if (c.ot_function === undefined) {
      this.renderMorphItem(b, c, __s.lexicon_grammar_function, "function");
    } else {
      this.renderMorphItem(b, c, __s.lexicon_grammar_function, "ot_function");
    }
    this.renderMorphItem(b, c, __s.lexicon_grammar_tense, "tense");
    this.renderMorphItem(b, c, __s.lexicon_grammar_voice, "voice");
    this.renderMorphItem(b, c, __s.lexicon_grammar_mood, "mood");
    this.renderMorphItem(b, c, __s.lexicon_grammar_stem, "stem");
    this.renderMorphItem(b, c, __s.lexicon_grammar_ot_action, "ot_action");
    this.renderMorphItem(b, c, __s.lexicon_grammar_ot_voice, "ot_voice");
    this.renderMorphItem(b, c, __s.lexicon_grammar_form, "ot_form");
    this.renderMorphItem(b, c, __s.lexicon_grammar_ot_tense, "ot_tense");
    this.renderMorphItem(b, c, __s.lexicon_grammar_ot_mood, "ot_mood");
    this.renderMorphItem(b, c, __s.lexicon_grammar_case, "wordCase");
    this.renderMorphItem(b, c, __s.lexicon_grammar_person, "person");
    this.renderMorphItem(b, c, __s.lexicon_grammar_number, "number");
    this.renderMorphItem(b, c, __s.lexicon_grammar_gender, "gender");
    this.renderMorphItem(b, c, __s.lexicon_grammar_state, "state");
    this.renderMorphItem(b, c, __s.lexicon_grammar_suffix, "suffix");
    b.append("<br class='GrammarInfo' style='display:none;line-height:4px'/>");
    if (c.explanation != undefined) {
      b.append(
        $(
          "<span class='GrammarInfo' style='font-weight:bold;display:none'>"
        ).append(__s.lexicon_ie + ": ")
      )
        .append(
          $("<span class='GrammarInfo' style='display:none'>").append(
            this.replaceEmphasis(c.explanation)
          )
        )
        .append("<br class='GrammarInfo'/>");
    }
    if (c.description != undefined) {
      b.append(
        $(
          "<span class='GrammarInfo' style='font-weight:bold;display:none'>"
        ).append(__s.lexicon_eg + ": ")
      ).append(
        $("<span class='GrammarInfo' style='display:none'>").append(
          this.replaceEmphasis(c.description)
        )
      );
    }
  },
  renderMorphItem: function (b, g, f, e) {
    if (g && e && g[e]) {
      var h = this.replaceEmphasis(g[e]);
      var d = h.toLowerCase().replace(/ /g, "_");
      if (
        typeof __s[d] === "string" &&
        __s[d].trim().toLowerCase() !== h.trim().toLowerCase()
      ) {
        h += " (" + __s[d] + ")";
      }
      var c = $(
        "<span class='GrammarInfo' style='display:none'>" + h + "</span>"
      );
      b.append(
        $(
          "<span class='GrammarInfo' style='font-weight:bold;display:none'>"
        ).append(f + ": ")
      ).append(c);
      if (g[e + "Explained"] || (e == "wordCase" && g.caseExplained)) {
        var a = g[e + "Explained"] || (e == "wordCase" && g.caseExplained);
        c.attr("title", this.stripEmphasis(a));
      }
      b.append("<br class='GrammarInfo' style='display:none'/>");
    }
  },
  replaceEmphasis: function (a) {
    return (a || "").replace(/_([^_]*)_/g, "<em>$1</em>");
  },
  stripEmphasis: function (a) {
    return (a || "").replace(/_([^_]*)_/g, "");
  },
  _createTabHeadersContainer: function () {
    var b =
      '<ul class="nav nav-tabs"><li style="display:none" class="active"><a class="glyphicon glyphicon-info-sign" title="<%= __s.original_word %>" data-toggle="tab" data-target="#lexicon"></li><li style="display:none"><a class="glyphicon glyphicon-stats" title="<%= __s.passage_stats %>" data-toggle="tab" data-target="#analysis"></li><li style="display:none"><a class="glyphicon glyphicon-bookmark" title="<%= __s.bookmarks_and_recent_texts %>" data-toggle="tab" data-target="#history"></li><li style="display:none"><a class="stepglyph-help glyphicon glyphicon-question-sign" title="<%= __s.frequently_asked_questions %>" data-toggle="tab" data-target="#help"></li><li style="display:none"><a title="<%= __s.display_grammarColor %>" data-toggle="tab" data-target="#color"></a></li></ul>';
    var a = $(_.template(b)());
    a.append(
      $(
        "<li class='closeSidebar'><a class='glyphicon glyphicon-remove' /></li>"
      ).click(this.closeSidebar)
    );
    return a;
  },
  toggleOpen: function () {
    if (!this.$el.closest(".row-offcanvas").hasClass("active")) {
      this.openSidebar();
    } else {
      this.closeSidebar();
    }
  },
  openSidebar: function () {
    this.sidebarButtonIcon.addClass("active");
    this.$el.closest(".row-offcanvas").addClass("active");
  },
  closeSidebar: function () {
    this.sidebarButtonIcon.removeClass("active");
    this.$el.closest(".row-offcanvas").removeClass("active");
    $(".lexiconFocus, .lexiconRelatedFocus").removeClass(
      "lexiconFocus lexiconRelatedFocus"
    );
  },
  σMO: function (c, d, a) {
    var b = this;
    c.on("mouseover", function () {
      b.σMN(c, d, a, false);
    }).on("touchstart", function () {
      b.σMN(c, d, a, true);
    });
  },
  σMM: function (a, b) {
    var c = this;
    $("[sbRef]", a).click(function (h) {
      h.preventDefault();
    });
    var f = $("[sbRef]", a);
    for (var d = 0; d < f.length; d++) {
      var e = f.eq(d);
      var g = e.attr("sbRef");
      e.click(function (h) {
        h.preventDefault();
      });
      this.σMO(e, g, b);
    }
  },
  σMN: function (c, d, a, e) {
    var b = this;
    if (!$.data(c, "initialised")) {
      require(["qtip", "drag"], function () {
        c.qtip({
          position: {
            my: "top right",
            at: "top left",
            viewport: $(window),
          },
          style: {
            tip: false,
            classes: "draggable-tooltip xrefPopup",
            width: {
              min: 800,
              max: 800,
            },
          },
          show: {
            event: "click",
          },
          hide: {
            event: "click",
          },
          content: {
            text: function (j, h) {
              var g = a;
              if (
                step.keyedVersions[a] &&
                step.keyedVersions[a].category != "BIBLE"
              ) {
                var l = _.where(b.model.get("searchTokens"), {
                  itemType: VERSION,
                });
                g = "ESV";
                for (var f = 0; f < l.length; f++) {
                  var k = step.keyedVersions[(l[f].item || {}).initials];
                  if (k != null && k.category == "BIBLE") {
                    g = k.initials;
                  }
                }
              }
              $.getSafe(
                BIBLE_GET_BIBLE_TEXT + g + "/" + encodeURIComponent(d),
                function (i) {
                  h.set("content.title.text", i.longName);
                  h.set(
                    "content.text",
                    i.value.replace(
                      / strong=['"][GH]\d{1,5}[A-Za-z]?\s?['"]/g,
                      ""
                    )
                  );
                  h.set("content.osisId", i.osisId);
                }
              ).error(function () {
                changeBaseURL();
              });
            },
            title: {
              text: d,
              button: false,
            },
          },
          events: {
            render: function (g, f) {
              $(f.elements.titlebar).css("padding-right", "0px");
              $(f.elements.titlebar)
                .prepend(
                  $(
                    '<span class="glyphicon glyphicon-new-window openRefInColumn"></span>'
                  ).click(function () {
                    step.util.σuX(
                      b.model.get("passageId"),
                      f.get("content.osisId"),
                      true,
                      null,
                      g
                    );
                  })
                )
                .prepend(
                  $(
                    '<button type="button" class="close" aria-hidden="true">X</button>'
                  ).on("click touchstart", function () {
                    f.hide();
                  })
                );
            },
            visible: function (h, g) {
              var i = g.elements.tooltip;
              var f = e ? ".qtip-title" : ".qtip-titlebar";
              if (e) {
                i.find(".qtip-title").css("width", "90%");
              }
              new Draggabilly($(i).get(0), {
                containment: "body",
                handle: f,
              });
            },
          },
        });
        $.data(c, "initialised", true);
      });
    }
  },
  _lookUpPersonInfo: function (b) {
    var c = $(".possiblePerson" + b.strongNumber);
    if (c.length == 0) {
      console.log("cannot find possible Person ID in html");
      c = $(".possiblePerson" + b.strongNumber);
    }
    var a =
      window.location && window.location.origin
        ? window.location.origin
        : window.location.protocol + "//" + window.location.host;
    c.empty().html(
      "<a href='" +
        a +
        "/html/J_AppsHtml/J_Genealogy/j_peopleSplit3.html?strong=" +
        b.strongNumber +
        "' target='_new'><button type='button' class='stepButton' ><b>Family</b></button></a>"
    );
  },
  _isItAPerson: function (c) {
    var a = c.strongNumber.trim();
    var b = this;
    if (Array.isArray(step.peopleList)) {
      if (step.peopleList.indexOf(a) > -1) {
        b._lookUpPersonInfo(c);
      }
      return;
    }
    $.getJSON("/html/json/J_AppsJson/J_Genealogy/j_people.json", function (d) {
      step.peopleList = d;
      if (d.indexOf(a) > -1) {
        b._lookUpPersonInfo(c);
      }
    });
  },
});
